<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="fragments/common::header('Create New Order')"></th:block>
<body>
	<div class="container-fluid">
		<!-- Navigation Bar -->
		<div class="row">
			<div class="col">
				<div th:replace="fragments/common::navbar">Navigation bar goes here</div>
			</div>
		</div>
		
		<form th:action="@{/orders}" th:object="${orderForm}" method="post">
			<div class="row">
				<div class="col">
					<div class="container mt-3 shadow p-3 mb-5 bg-white rounded">
						<!-- New Product  Form -->
						<h2>NEW ORDER</h2>
						<div class="clearfix">
					    	<button type="button" id="addProduct" class="btn btn-dark float-right">Add Product</button>
					    </div>
					    <hr/>
						<input type="hidden" th:field="*{order.id}" />
							<!-- Product Selection -->
							<div id="productContainer">
<!-- 								<div class="row"> -->
<!-- 									<div class="col-sm-2"> -->
										
<!-- 									</div> -->
									
<!-- 									Category Label -->
<!-- 									<div class="col-sm-3"> -->
<!-- 										<label for="category.id">Product Category:</label>  -->
<!-- 									</div> -->
									
<!-- 									Product Label -->
<!-- 									<div class="col-sm-3"> -->
<!-- 										<label for="product.id">Product:</label>  -->
<!-- 									</div> -->
									
<!-- 									Quantity Label -->
<!-- 									<div class="col-sm-2"> -->
<!-- 										<label for="quantity">Quantity:</label>  -->
<!-- 									</div> -->
									
<!-- 									Total Label -->
<!-- 									<div class="col-sm-2"> -->
<!-- 										<label for="totalAmount">Amount:</label>  -->
<!-- 									</div> -->
<!-- 								</div> -->
								
								<div id="productRow" class="row form-group" th:each="orderItem, i : ${orderForm.orderItems}">
									
									<!-- Remove -->
									<div class="col-sm-1">
										<button id="removeButton" type="button" class="form-control btn btn-danger float-right">x</button>
									</div>
									
									<!-- Category -->
									<div class="col-sm-2">
										<div class="form-group">
											<select class="form-control category" th:value="${orderItem.categoryId}" id="category0" name="category" data-toggle="tooltip" data-placement="bottom" title="Category">
												<option selected>Category...</option>
												<option th:each="cat : ${categories}" th:value="${cat.id}"
													th:text="${cat.name}"
													></option>
											</select>
										</div>
									</div>
									
									<!-- Product -->
									<div class="col-sm-3">
										<div class="form-group">
											<select class="form-control" id="product0" name="product" th:value="${orderItem.product}" data-toggle="tooltip" data-placement="bottom" title="Product">
												<option disabled="disabled" selected>Product...</option>
												
											</select>
										</div>
									</div>
									
									<!-- Quantity -->
									<div class="col-sm-2">
										<div class="form-group">
											<span class="validationError text-danger" th:if="${#fields.hasErrors('orderItems[__${i.index}__].quantity')}" th:errors="*{orderItems[__${i.index}__].quantity}"></span>
											<input name="quantity" id="quantity" class="form-control" type="number" min=0 th:field="*{orderItems[__${i.index}__].quantity}" data-toggle="tooltip" data-placement="bottom" title="Quantity"/>
										</div>
									</div>
									
									<!-- Override Price -->
									<div class="col-sm-2">
										<div class="form-group">
											<input name="priceOverride" id="priceOverride" class="form-control" type="number" min=0 th:field="*{orderItems[__${i.index}__].priceOverride}" data-toggle="tooltip" data-placement="bottom" title="Override Unit Price"/>
										</div>
									</div>
									
									<!-- Total -->
									<div class="col-sm-2">
										<div class="form-group">
											<input name="totalAmount" id="totalAmount" class="form-control" type="number" th:field="*{orderItems[__${i.index}__].totalAmount}" placeholder=0 readonly data-toggle="tooltip" data-placement="bottom" title="Sub Total"/>
										</div>
									</div>
								</div>
							</div>
							<hr/>
							
							<!-- Total Amount Computed -->
							<div class="row">
								<div class="col-sm-8">
								</div>
								<div class="col-sm-2">
									<p>TOTAL AMOUNT</p>
								</div>
								<div class="col-sm-2">
									<div class="form-group">
										<input name="totalAmountComputed" id="totalAmountComputed" class="form-control" type="number" th:field="*{order.totalAmount}" readonly/>
									</div>
								</div>
							</div>
						
						<!-- Order Details -->	
						<div class="row">
							<!-- Customer-->
							<div class="col-sm">
								<div class="form-group">
									<label for="customer.id">Customer:</label>
									<select class="form-control" id="customer.id" name="customer.id">
										<option selected>Select...</option>
										<option th:each="cust : ${customers}" th:value="${cust.id}" th:text="${cust.name}"></option>
									</select>
								</div>
							</div>
							
							<!-- Payment Type -->
							<div class="col-sm">
								<div class="form-group">
									<span class="validationError text-danger" th:if="${#fields.hasErrors('order.paymentType')}" th:errors="*{order.paymentType}"></span>
									<label for="paymentType">Payment Type:</label> 
									<input class="form-control" type="text" th:field="*{order.paymentType}" />
								</div>
							</div>
							
							<!-- Monthly Due Date -->
							<div class="col-sm">
								<div class="form-group">
									<label for="monthlyDue">Monthly Due Date:</label> 
									<input class="form-control" type="number" th:field="*{order.monthlyDueDate}" />
								</div>
							</div>
						</div>
						
						<!-- Remarks -->
						<div class="row">
							<div class="col-sm">
								<div class="form-group">
									<label for="remarks">Remarks:</label>
									<textarea class="form-control" th:field="*{order.remarks}"></textarea>
								</div>
							</div>
						</div>
						
						<div class="clearfix">
							<button type="submit" class="btn btn-dark float-right ml-1">Save</button>
							<a th:href="@{/orders}" class="btn btn-dark float-right">Cancel</a>
						</div>
					</div>
				</div>
			</div>
		</form>
		<!-- Footer -->
		<th:block th:replace="fragments/common::footer"></th:block>
	</div>
	
	<th:block th:replace="fragments/common::javascript"></th:block>
	
	<script th:inline="javascript">
		
		$('#productContainer').on('change','.category',
			function() {
				var catId = $(this).val();
				var rowNum = 0;
				rowNum = $(this).attr("id").replace("category", "");
				console.log(rowNum);
				
				$.getJSON("http://localhost:8080/api/productCategories/" + catId + "/products", {
	                ajax : 'true'
	            }, function(data) {
	            	var html = '<option value="">Product...</option>';
	                var products = data._embedded.products;
	                
	                var productOptions = products.reduce(
	                	(a,p) => a+=`<option value="${p.id}">${p.name}</option>`
	                	, ''
	                	)
	                	
	                html += productOptions;
	                
// 	                var len = products.length;
// 	                for ( var i = 0; i < len; i++) {
// 	                    html += '<option value="' + products[i].id + '">'
// 	                            + products[i].name + '</option>';
// 	                }
// 	                html += '</option>';
	                
	                $('#product'+rowNum).html(html);
	            });
        });
	
		function removeProduct(index){
			$("#productRow"+index).remove();
		}
	
		$(function () {
			$('[data-toggle="tooltip"]').tooltip();
		})
		
		var i = 0;
	
	 	$(document).ready(function() {
			 
			 // Add Product
			 $("#addProduct").click(function() {
				 
				 let categories = /*[[${categories}]]*/[];
				 
				 var options = categories.reduce(
					(a,c) => a+=`<option value="${c.id}">${c.name}</option>`
	                	, ''
				 )
				 
				 var productRowWrapper = 
					 $(`
						<div id="productRow`+i+`" class="row form-group">
							<!-- Remove -->
							<div class="col-sm-1">
								<button id="removeButton" onclick="removeProduct(`+i+`)" type="button" class="form-control btn btn-danger float-right">x</button>
							</div>
							
							<!-- Category -->
							<div class="col-sm-2">
								<div class="form-group">
									<select class="form-control category" id="category`+i+`" name="category" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Category">
										<option selected>Category...</option>
										${options}
									</select>
								</div>
							</div>
							
							<!-- Product -->
							<div class="col-sm-3">
								<div class="form-group">
									<select class="form-control" id="product`+i+`" name="product" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Product">
										<option disabled="disabled" selected>Product...</option>
										
									</select>
								</div>
							</div>
							
							<!-- Quantity -->
							<div class="col-sm-2">
								<div class="form-group">
									<input name="orderItems[`+i+`].quantity" id="quantity" class="form-control" type="number" data-toggle="tooltip" data-placement="bottom" title="Quantity" >
								</div>
							</div>
							
							<!-- Override Price -->
							<div class="col-sm-2">
								<div class="form-group">
									<input name="orderItems[`+i+`].priceOverride" id="priceOverride" class="form-control" type="number" data-toggle="tooltip" data-placement="bottom" title="Override Unit Price"/>
								</div>
							</div>
							
							<!-- Total -->
							<div class="col-sm-2">
								<div class="form-group">
									<input name="orderItems[`+i+`].totalAmount" id="totalAmount" class="form-control" type="number" readonly="" data-toggle="tooltip" data-placement="bottom" title="Sub Total">
								</div>
							</div>
						</div>
					 `);
				 
				 $("#productContainer").append(productRowWrapper);
				 $('[data-toggle="tooltip"]').tooltip();
				 i++;
			 });
			 
			$('[id="productRow"]').each(function() {
				var rowNumbered = "productRow"+i;
					$(this).attr("id", rowNumbered);
					i++;
			});
			
			$(this).find('[id="removeButton"]').each(function() {
				var removeProductCall = "removeProduct("+i+")";
				$(this).attr("onclick", removeProductCall);
			});
			
		 });
	
	</script>
</body>
</html>